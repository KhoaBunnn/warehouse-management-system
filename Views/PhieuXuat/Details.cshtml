@model QLKhoHang.Models.PhieuXuat

@{
    ViewData["Title"] = "Chi tiết phiếu xuất";
    var tongTien = 0M;
}

<h2 class="mb-4">📤 Chi tiết phiếu xuất</h2>

<div class="card p-3 mb-4">
    <p><strong>Mã phiếu:</strong> @Model.MaPX</p>
    <p><strong>Ngày xuất:</strong> @Model.NgayXuat.ToString("dd/MM/yyyy")</p>
    <p><strong>Nhân viên:</strong> @Model.NhanVien?.TenNV</p>
    <p><strong>Khách hàng:</strong> @Model.KhachHang?.TenKH</p>
</div>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<a asp-action="AddDetail"
   asp-route-id="@Model.MaPX"
   class="btn btn-success mb-3"
   data-bs-toggle="collapse"
   data-bs-target="#addForm">
    ➕ Thêm chi tiết
</a>

<div id="addForm" class="collapse mb-4">
    <div class="card p-3">
        <form asp-action="AddDetail" method="post">
            <input type="hidden" name="maPX" value="@Model.MaPX" />

            <div class="row">
                <div class="col-md-5 mb-2">
                    <label>Hàng hóa</label>
                    <select name="maHang" class="form-control" required>
                        <option value="">-- chọn hàng --</option>
                        @foreach (var h in ViewBag.HangHoa)
                        {
                            <option value="@h.MaHang">@h.TenHang (@h.SoLuongTon)</option>
                        }
                    </select>
                </div>

                <div class="col-md-2 mb-2">
                    <label>Số lượng</label>
                    <input type="number" name="soLuong" class="form-control" min="1" value="1" required />
                </div>

                <div class="col-md-3 mb-2">
                    <label>Đơn giá xuất</label>
                    <input type="number" name="donGia" step="0.01" class="form-control" required />
                </div>

                <div class="col-md-2 align-self-end mb-2">
                    <button type="submit" class="btn btn-success w-100">Thêm</button>
                </div>
            </div>
        </form>
    </div>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-dark text-center">
        <tr>
            <th>Mã hàng</th>
            <th>Tên hàng</th>
            <th>Số lượng</th>
            <th>Đơn giá xuất</th>
            <th>Thành tiền</th>
            <th width="100">Thao tác</th>
        </tr>
    </thead>

    <tbody>
        @if (Model.CT_PhieuXuat != null && Model.CT_PhieuXuat.Any())
        {
            foreach (var ct in Model.CT_PhieuXuat)
            {
                var thanhTien = ct.SoLuong * ct.DonGiaXuat;
                tongTien += thanhTien;

                <tr>
                    <td>@ct.MaHang</td>
                    <td>@ct.HangHoa?.TenHang</td>
                    <td class="text-center">@ct.SoLuong</td>
                    <td class="text-end">@ct.DonGiaXuat.ToString("N0")</td>
                    <td class="text-end">@thanhTien.ToString("N0")</td>

                    <td class="text-center">
                        <form asp-action="DeleteDetail"
                              asp-controller="PhieuXuat"
                              method="post"
                              onsubmit="return confirm('Xóa hàng này khỏi phiếu xuất?');">

                            <input type="hidden" name="maPX" value="@ct.MaPX" />
                            <input type="hidden" name="maHang" value="@ct.MaHang" />
                            <button type="submit" class="btn btn-danger btn-sm">Xóa</button>
                        </form>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="6" class="text-center text-muted">
                    Chưa có chi tiết
                </td>
            </tr>
        }
    </tbody>

    <tfoot class="table-secondary">
        <tr>
            <th colspan="4" class="text-end">TỔNG TIỀN</th>
            <th class="text-end">@tongTien.ToString("N0") VNĐ</th>
            <th></th>
        </tr>
    </tfoot>
</table>

<a asp-action="Index" class="btn btn-secondary mt-3">🔙 Quay lại danh sách</a>
