@model QLKhoHang.Models.ReportsIndexViewModel

@{
    ViewData["Title"] = "Báo cáo nhập/xuất/tồn";
}

<style>
    .reports-container {
        padding: 22px;
    }

    .reports-filters .form-label {
        font-weight: 600;
        color: var(--text);
    }

    .reports-actions .btn {
        min-width: 120px;
    }

    .report-metrics {
        display: flex;
        gap: 20px;
        margin: 18px 0 26px;
    }

    .report-metric {
        flex: 1;
        background: linear-gradient(180deg,#ffffff, #fbfdff);
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 10px 24px rgba(6,30,48,0.06);
        border: 1px solid rgba(6,30,48,0.04);
    }

    .metric-top {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #fff;
    }

    .icon-nhap {
        background: linear-gradient(135deg,#06b6d4,#06a89e);
    }

    .icon-xuat {
        background: linear-gradient(135deg,#f97316,#ef4444);
    }

    .icon-ton {
        background: linear-gradient(135deg,#06b6d4,#60a5fa);
    }

    .metric-value {
        font-size: 28px;
        font-weight: 700;
        margin-top: 6px;
        color: var(--text-dark);
    }

    .metric-sub {
        color: rgba(6,40,61,0.65);
        margin-top: 6px;
    }

    .report-section {
        margin-top: 8px;
    }

        .report-section h5 {
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px;
        }

    .table-friendly thead {
        background: linear-gradient(90deg, rgba(14,165,233,0.05), rgba(16,163,74,0.02));
    }

        .table-friendly thead th {
            color: #0b2740;
            font-weight: 700;
        }

    .table-friendly tbody td {
        padding: 14px 12px;
        vertical-align: middle;
    }

    .table-friendly tbody tr:hover {
        background: rgba(6,40,61,0.02);
    }

    .summary-note {
        color: rgba(6,40,61,0.6);
        font-size: 0.95rem;
    }

    @@media (max-width: 767px) {
        .report-metrics {
            flex-direction: column;
        }
    }
</style>

<div class="card-glass p-4 reports-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title mb-0">@ViewData["Title"]</h4>
    </div>

    <form method="get" class="row g-3 mb-3 reports-filters">
        <div class="col-md-3">
            <label class="form-label">Từ ngày</label>
            <input type="date" name="from" value="@Model.From.ToString("yyyy-MM-dd")" class="form-control" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Đến ngày</label>
            <input type="date" name="to" value="@Model.To.ToString("yyyy-MM-dd")" class="form-control" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Hàng hóa</label>
            <select name="maHH" class="form-select">
                <option value="">-- Tất cả --</option>
                @foreach (var h in Model.HangHoaList)
                {
                    <option value="@h.MaHang" selected="@(h.MaHang == Model.MaHH ? "selected" : null)">@h.TenHang</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Kho</label>
            <select name="maKho" class="form-select">
                <option value="">-- Tất cả --</option>
                @foreach (var k in Model.KhoList)
                {
                    <option value="@k.MaKho" selected="@(k.MaKho == Model.MaKho ? "selected" : null)">@k.TenKho</option>
                }
            </select>
        </div>

        <div class="col-12 d-flex gap-2 reports-actions">
            <button type="submit" class="btn btn-primary">Lọc</button>
            <a asp-action="ExportCsv" asp-route-from="@Model.From.ToString("yyyy-MM-dd")" asp-route-to="@Model.To.ToString("yyyy-MM-dd")" asp-route-maHH="@Model.MaHH" asp-route-maKho="@Model.MaKho" class="btn btn-outline-secondary">Xuất CSV</a>
            <a asp-action="Index" class="btn btn-light">Đặt lại</a>
        </div>
    </form>

    <div class="report-metrics">
        <div class="report-metric">
            <div class="metric-top">
                <div class="metric-icon icon-nhap"><i class="bi bi-box-arrow-in-down"></i></div>
                <div>
                    <div class="text-muted">Tổng số lượng nhập</div>
                    <div class="metric-value">@Model.TotalNhapQty</div>
                </div>
            </div>
            <div class="metric-sub">Tổng giá trị: <strong>@Model.TotalNhapValue.ToString("N0") VNĐ</strong></div>
        </div>

        <div class="report-metric">
            <div class="metric-top">
                <div class="metric-icon icon-xuat"><i class="bi bi-box-arrow-up"></i></div>
                <div>
                    <div class="text-muted">Tổng số lượng xuất</div>
                    <div class="metric-value">@Model.TotalXuatQty</div>
                </div>
            </div>
            <div class="metric-sub">Tổng giá trị: <strong>@Model.TotalXuatValue.ToString("N0") VNĐ</strong></div>
        </div>

        <div class="report-metric">
            <div class="metric-top">
                <div class="metric-icon icon-ton"><i class="bi bi-stack"></i></div>
                <div>
                    <div class="text-muted">Số lượng tồn</div>
                    <div class="metric-value">@Model.TotalTonQty</div>
                </div>
            </div>
            <div class="metric-sub">Giá trị tồn: <strong>@Model.TotalTonValue.ToString("N0") VNĐ</strong></div>
        </div>
    </div>

    <div class="report-section">
        <h5>Biểu đồ tổng số lượng</h5>
        <div class="card-glass p-3 mb-3">
            <canvas id="reportsTrend" height="150"></canvas>
        </div>
    </div>

    <div class="report-section">
        <h5>Nhập hàng</h5>
        <div class="summary-note mb-2">Hiển thị @((Model.NhapList ?? Enumerable.Empty<QLKhoHang.Models.ReportEntryViewModel>()).Count()) giao dịch.</div>
        <table class="table table-striped table-friendly">
            <thead>
                <tr>
                    <th>Tham chiếu</th>
                    <th>Ngày</th>
                    <th>Hàng</th>
                    <th>Kho</th>
                    <th>Số lượng</th>
                    <th>Giá trị</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model.NhapList ?? Enumerable.Empty<QLKhoHang.Models.ReportEntryViewModel>())
                {
                    <tr>
                        <td>@r.RefId</td>
                        <td>@r.Ngay.ToString("yyyy-MM-dd")</td>
                        <td>@r.TenHang</td>
                        <td>@r.MaKho</td>
                        <td>@r.Quantity</td>
                        <td>@r.Value.ToString("N0")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="report-section">
        <h5>Xuất hàng</h5>
        <div class="summary-note mb-2">Hiển thị @((Model.XuatList ?? Enumerable.Empty<QLKhoHang.Models.ReportEntryViewModel>()).Count()) giao dịch.</div>
        <table class="table table-striped table-friendly">
            <thead>
                <tr>
                    <th>Tham chiếu</th>
                    <th>Ngày</th>
                    <th>Hàng</th>
                    <th>Kho</th>
                    <th>Số lượng</th>
                    <th>Giá trị</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model.XuatList ?? Enumerable.Empty<QLKhoHang.Models.ReportEntryViewModel>())
                {
                    <tr>
                        <td>@r.RefId</td>
                        <td>@r.Ngay.ToString("yyyy-MM-dd")</td>
                        <td>@r.TenHang</td>
                        <td>@r.MaKho</td>
                        <td>@r.Quantity</td>
                        <td>@r.Value.ToString("N0")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="report-section">
        <h5>Tồn kho</h5>
        <div class="summary-note mb-2">Hiển thị @((Model.TonList ?? Enumerable.Empty<QLKhoHang.Models.ReportEntryViewModel>()).Count()) mục tồn.</div>
        <table class="table table-striped table-friendly">
            <thead>
                <tr>
                    <th>Hàng</th>
                    <th>Kho</th>
                    <th>Ngày</th>
                    <th>Số lượng</th>
                    <th>Giá trị</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model.TonList ?? Enumerable.Empty<QLKhoHang.Models.ReportEntryViewModel>())
                {
                    <tr>
                        <td>@r.TenHang</td>
                        <td>@r.MaKho</td>
                        <td>@r.Ngay.ToString("yyyy-MM-dd")</td>
                        <td>@r.Quantity</td>
                        <td>@r.Value.ToString("N0")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = ["Tổng Nhập", "Tổng Xuất", "Tồn kho"];
    const data = [@Model.TotalNhapQty, @Model.TotalXuatQty, @Model.TotalTonQty];

    var ctx = document.getElementById('reportsTrend')?.getContext('2d');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Số lượng',
                    data: data,
                    backgroundColor: ['#06b6d4', '#ef4444', '#10b981']
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
</script>
